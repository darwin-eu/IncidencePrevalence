---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
fig.path = "man/figures/README-",
out.width = "100%"
)
```

# IncidencePrevalence

<!-- badges: start -->
[![codecov.io](https://codecov.io/github/darwin-eu/IncidencePrevalence/coverage.svg?branch=main)](https://codecov.io/github/darwin-eu/IncidencePrevalence?branch=main)
[![R-CMD-check](https://github.com/darwin-eu/IncidencePrevalence/workflows/R-CMD-check/badge.svg)](https://github.com/darwin-eu/IncidencePrevalence/actions)
[![Lifecycle:Experimental](https://img.shields.io/badge/Lifecycle-Experimental-339999)](https://www.tidyverse.org/lifecycle/#experimental)
<!-- badges: end -->

## Package overview

IncidencePrevalence contains functions for estimating population-level incidence and prevalence using the OMOP common data model.  


## Package installation

You can install the development version of IncidencePrevalence like so:

```{r, eval=FALSE}
install.packages("remotes")
remotes::install_github("darwin-eu/IncidencePrevalence")
```

When working with IncidencePrevalence, you will use CDMConnector to manage your connection to the database. If you don´t already have this installed then you can install it in the same way:
```{r, eval=FALSE}
remotes::install_github("darwin-eu/CDMConnector")
```

## Example
First, we need to create a cdm reference for the data we´ll be using. Here we´ll generate an example with simulated data, but to see how you would set this up for your database please consult the CDMConnector package documentation.

```{r}
library(CDMConnector)
library(IncidencePrevalence)

# We first need to create a cdm_reference 
cdm<-mockIncidencePrevalenceRef(sampleSize=5000)
# this is what the person table for this example data looks like
head(cdm$person)
```

To identify our denominator population we can use the `generateDenominatorCohortSet` function. Here for example, we want to identify a denominator population for a study period between 2008 and 2018. To note, other options ave available when defining this population which are summarised in the package vignettes. 

```{r}
cdm$denominator <- generateDenominatorCohortSet(
  cdm = cdm,
  startDate = as.Date("2008-01-01"),
  endDate = as.Date("2018-01-01")
)
# this is what the resulting cohort data looks like
head(cdm$denominator)
```

We can also see the reasons people in the database did not enter the cohort 
```{r}
attrition(cdm$denominator)
```

Now we have identified our denominator population, we can calculate incidence, point prevalence, and period prevalence as below (given that our mock cdm reference also has an outcome cohort defined). Again further details for each of these functions are provided in the vignettes.

```{r}
inc <- estimateIncidence(
  cdm = cdm,
  denominatorTable = "denominator",
  outcomeTable = "outcome"
)
dplyr::glimpse(inc)
```

```{r}
prev_point <- estimatePointPrevalence(
  cdm = cdm,
  denominatorTable = "denominator",
  outcomeTable = "outcome",
  interval = "months"
)
dplyr::glimpse(prev_point)
```

```{r}
prev_period <- estimatePeriodPrevalence(
  cdm = cdm,
  denominatorTable = "denominator",
  outcomeTable = "outcome",
  interval = "months"
)
dplyr::glimpse(prev_period)
```

For a result set we can also obtain extra related information. 

We can see the attrition
```{r}
attrition(prev_period)
```

We can also have a reference to the study participants that informed the analysis
```{r}
participants(prev_period)
```



