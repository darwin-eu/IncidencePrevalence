---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
fig.path = "man/figures/README-",
out.width = "100%"
)
```

# IncidencePrevalence

<!-- badges: start -->
[![codecov.io](https://codecov.io/github/darwin-eu/IncidencePrevalence/coverage.svg?branch=main)](https://codecov.io/github/darwin-eu/IncidencePrevalence?branch=main)
[![R-CMD-check](https://github.com/darwin-eu/IncidencePrevalence/workflows/R-CMD-check/badge.svg)](https://github.com/darwin-eu/IncidencePrevalence/actions)
[![Lifecycle:Experimental](https://img.shields.io/badge/Lifecycle-Experimental-339999)](https://www.tidyverse.org/lifecycle/#experimental)
<!-- badges: end -->

## Package overview

IncidencePrevalence contains functions for estimating population-level incidence and prevalence using the OMOP common data model.  


## Package installation

You can install the development version of IncidencePrevalence like so:

```{r, eval=FALSE}
install.packages("remotes")
remotes::install_github("darwin-eu/IncidencePrevalence")
```

When working with IncidencePrevalence, you will use CDMConnector to manage your connection to the database. If you don´t already have this installed then you can install it in the same way:
```{r, eval=FALSE}
remotes::install_github("darwin-eu/CDMConnector")
```

## Example
First, we need to create a cdm_reference for the data we´ll be using. Here we´ll use generate an example one, but to see how you would set this up for your database please consult the CDMConnector documentation at https://odyosg.github.io/CDMConnector/

```{r}
library(CDMConnector)
library(IncidencePrevalence)

# We first need to create a cdm_reference 
cdm<-generate_mock_incidence_prevalence_db(sample_size=5000)
# and this is what this example data looks like
head(cdm$person)
head(cdm$observation_period)
head(cdm$outcome)
```

To identify our denominator population we can use the `collect_denominator_pops` function. Here for example, we want to identify a denominator population for a study period between 2008 and 2018. To note, other options ave available when defining this population which are summarised in the package vignettes. 

```{r}
dpop <- collect_denominator_pops(
  cdm_ref = cdm,
  study_start_date = as.Date("2008-01-01"),
  study_end_date = as.Date("2018-01-01")
)
# this is what the data looks like
head(dpop$denominator_population)
head(dpop$attrition)
```

Now we have identified our denominator population, we can calculate incidence, point prevalence, and period prevalence as below (given that our mock cdm_reference also has an outcome cohort defined). Again further details for each of these functions are provided in the vignettes.

To do this, first we´ll add the denominator cohort to our cdm reference.
```{r}
cdm$denominator <- dpop$denominator_population
```

Now we´ve added the denominator cohort to our cdm reference, we can go on and estimate incidence and prevalence. 

```{r}
# where the table with the outcome cohort is 
# in a table called ´outcome´
# schema called ´results´
inc <- collect_pop_incidence(
  cdm_ref = cdm,
  table_name_denominator = "denominator",
  table_name_outcomes = "outcome",
  cohort_ids_outcomes = "1",
  cohort_ids_denominator_pops="1"
)
head(inc$incidence_estimates)
```

```{r}
prev_point <- collect_pop_prevalence(
  cdm_ref = cdm,
  table_name_denominator = "denominator",
  cohort_ids_denominator_pops="1",
  table_name_outcomes = "outcome",
  cohort_ids_outcomes = "1",
  time_intervals = "months",
  type = "point"
)
head(prev_point$prevalence_estimates)
```

```{r}
prev_period <- collect_pop_prevalence(
  cdm_ref = cdm,
  table_name_denominator = "denominator",
  table_name_outcomes = "outcome",
  cohort_ids_outcomes = "1",
  cohort_ids_denominator_pops="1",
  time_intervals = "months",
  type = "period"
)
head(prev_period$prevalence_estimates)
```

