---
title: "Creating numerator populations"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{a04_Creating_numerator_populations}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r, message= FALSE, warning=FALSE, echo=FALSE}
library(here)
library(knitr)
```


## Introduction
This package is designed to be called against databases mapped to the OMOP CDM format using OHDSI tools. Functions `computeIncidence()` and `computePrevalence()` calculate incidence and prevalence rates of a particular outcome in a given population, which we refer to as the denominator population. In order to use these functions, we need to point to a table containing an outcome cohort in our server.

## Defining an outcome cohort
The definition of cohorts used in this package correspond to the one applied in OHDSI research (https://ohdsi.github.io/TheBookOfOhdsi/Cohorts.html). In this line, we define a cohort is a set of patients who satisfy one or more inclusion criteria for a duration of time. Cohorts can be generated based on a definition in ATLAS but can also be generated using other approaches. 

```{r,echo=FALSE, out.width="80%"}
knitr::include_graphics(here("vignettes/numerator_pop_fig1.png"))
```

To use this package the user will need to define cohorts containg the set of patients that experience our outcome of interest (from now on we will refer to this cohort as the outcome cohort). This cohort will need to have the following columns: 

```{r, fig.show='hold', echo=FALSE, warning=FALSE}
table <- data.frame("Unique subject ID", "Cohort ID",
                    "Entry date cohort", "Exit date cohort")
colnames(table) <- c("subject_id", "cohort_definition_id",
                     "cohort_start_date", "cohort_end_date")
kable(table)
```

Cohort_start_date is the date in which individuals enter the cohort (i.e, cohort index date), as they experience a cohort entry event. Cohort entry events can be any event recorded in the database such as drug exposures, conditions, procedures, measurements and visits.  

Cohort_end_date represents the date when a person no longer qualifies for cohort membership. Cohort exit can be defined in multiple ways such as the end of observation period, a fixed time interval relative to the initial entry event, the end of a continuous drug exposure, or through other censoring of observation period. Note that cohort exit strategy will impact whether a person can belong to the cohort multiple times during different time intervals. 

### ATLAS approach:
If we use ATLAS to define our outcome cohort, we will need to consider several aspects that will impact our analysis, such as event persistence and restrictions in the number of events occurring per person. 

Event persistence will impact results for both incidence and prevalence rates. For incidence rates, we can decide whether we want to restrict our analysis to first events or if we want to include all the events that occur per person. If we want to consider multiple events per person, the duration of these events will be of importance, as we are not going to capture subsequent events if prior events have not been concluded. Therefore, we must specify a cohort exit strategy aside from setting the exit date as the end of observation period. Event persistence will also influence results generated by `computePrevalence()` when computing point prevalence estimates, as the number of individuals included in the outcome cohort will differ depending on the cohort exit strategy defined.

```{r,echo=FALSE, out.width="80%"}
knitr::include_graphics(here("vignettes/numerator_pop_fig2.png"))
```

Note that if we allow individuals to belong to the cohort outcome multiple times, we will need to capture all the occurrences in which individuals experience our event. Therefore, we cannot apply any restriction to limit the number of events we are capturing per person. While doing the opposite could be interesting for studies aiming to capture only first events, we recommend not to apply this option in ATLAS, as it can be specified while running the package.

```{r,echo=FALSE, out.width="80%"}
knitr::include_graphics(here("vignettes/numerator_pop_fig3.png"))
```

In addition, this package allows the user to exclude participants who experienced the outcome during a particular period of time relative to their study index date. Therefore, restricting this option could hamper our ability to identify the latest event that individuals experience before being included in the study, which could alter their subsequent study index date. Considering all the above, we only recommend restricting ATLAS definitions to first events if the user is not interested in further occurrences and if all prior history is considered to exclude participants who have already experienced the event. 

Cohort entry events can also be restricted by requiring a specific number of days as continuous observation before or after the event. It is important to note that these requirements will be applied relative to the date of the entry event (i.e, outcome date). The `study_denominator_pop()` function, used to identify the denominator population, can also be set to include a specific number of days as a prior history requirement. However, this requirement is applied relative to their study index date, and it is not related to the cohort entry event date for an outcome cohort. Therefore, it is up to the user to decide whether a specific history requirement is applied only to denominator or outcome cohorts, or both.

Other inclusion criteria can be applied to further restrict the set of individuals included in this cohort. However, it is important to consider that some of these criteria (such as age and sex) can also be applied while running the functions included in this package, and therefore, there is no need to further restrict this features in ATLAS. Similarly, study start and end date can also be set while running the package. 

To note, it is important to consider that ATLAS definitions will only capture events that occurred during the observation period of each individual. Therefore, ATLAS definitions will not consider events registered retrospectively, such as those that occurred before the implementation of electronic health records or those that occurred before a patient was registered in the database.The impact of this feature will depend on each database and how events prior to the start of observation period have been recorded while converting the database to the OMOP CDM.

### Non-ATLAS approach:
The user can also create their own cohort outcome cohort without the need to use specific OHDSI tools. However, the structure of the outcome table has to include exactly the same columns that we would have obtained using ATLAS (subject_id, cohort_id_definition, cohort_start_date, cohort_end_date).

Moreover, the user will need to decide in advance the same features explained above, such as evidence persistence or allowing for multiple events per person. As previously mentioned, we recommend not to restrict events to first occurrences. On the other hand, databases might include the cohort end date of a particular event, such a condition or prescription. Contrary to outcome cohorts generated with ATLAS, the rationale for this date will depend on each individual. It is up to the user to decide whether to use this cohort exit date or apply a common cohort exit strategy for all patients. 

## Instantiate cohort outcome to the CDM:
If using ATLAS, the user will need to export their definitions using sql files. These files will be needed to be run against the database and inserted into the server using the SqlRender R package (https://github.com/OHDSI/SqlRender).


```{r eval=FALSE}
sql <- readSql("...") # directory of the sql file
sql <- SqlRender::translate(sql, targetDialect = targetDialect)
renderTranslateExecuteSql(
  conn = "...", # connection details
  sql,
  cdm_database_schema = "...",
  vocabulary_database_schema = "...",
  target_database_schema = "...",
  target_cohort_table = "...",
  target_cohort_id = "..."
)
```


If other approaches are used, the outcome cohort table generated by the user will be needed to be inserted into the server using the DatabaseConnector R package (https://github.com/OHDSI/DatabaseConnector).

```{r eval=FALSE}
insertTable(
  connection = "...", # connection details
  tableName = "...", # name of the server table including inserted results
  data = "...", # name of the dataframe containing our outcome cohort in R
  createTable = TRUE,
  progressBar = FALSE
)
```

If more than one outcome cohorts are inserted into the server in the same table, the user will be needed to provide different identification numbers for each cohort (cohort_definition_id).

To note, any existing tables in the server and schema with the same name will be overwritten.
