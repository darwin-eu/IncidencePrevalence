---
title: "Creating denominator population using a cohort"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{a03_Creating_denominator_population_using_a_cohort}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

## Introduction
The `collectDenominatorPops()` function is designed to identify the individuals and the time their satisfy a set different set of criteria (age, sex, prior amount of prior history observed) in a particular time period.

This function can be run against a the whole database (see prior vignette "Creating denominator populations"). However, it's also designed to be run against a subset of the population, which can be specified in the same function. This subset can be identified based on information recorded in our database, such as sociodemographic characteristics (ethnicity, socioeconomic status...), conditions or users of particular medication, among others.


## Defining a subset cohort
In order to identify our denominator population among a particular subset of individuals, we need to point to a table containing our subset cohort in our server.

Subset cohorts must be inserted in the server before running the `collectDenominatorPops()` function. They can be generated based on different strategies, such as by bespoke code or by using ATLAS. 

Further information on how to define, structure or insert these tables in the server can be found in the next vignette (see "Creating numerator populations").

When setting the `collectDenominatorPops()` arguments, we'll need to specify the schema and table where our subset cohort is recorded (strata_schema and strataTable). In case we have multiple subsets, we'll also need to specify the identification of the particular strata we're interested in (strataCohortId). 

To note, it's important to consider that some of these characteristics used to define our subset might remain constant during the whole observation period (e.g., ethnicity) and some might change (e.g., suffering from a particular condition or taking a particular medication).

## Using collectDenominatorPops() against a population subgroup
To demonstrate its use, letÂ´s load the IncidencePrevalence package (along with a couple of packages to help for subsequent plots) and generate 10 example patients using the `generate_mock_incidence_prevalence_db()` function.

```{r, message=FALSE, warning=FALSE}
library(IncidencePrevalence)
library(ggplot2)
library(tidyr)
person <- tibble(
    person_id = c("1","2","3", "4","5"),
    gender_concept_id = c(rep("8507",2), rep("8532", 3)),
    year_of_birth = 2000,
    month_of_birth = 06,
    day_of_birth = 01
  )
  observation_period <- tibble(
    observation_period_id = "1",
    person_id = c("1","2","3", "4","5"),
    observation_period_start_date = c(as.Date("2010-12-19"),
                                      as.Date("2005-04-01"),
                                      as.Date("2009-04-10"),
                                      as.Date("2010-08-20"),
                                      as.Date("2010-01-01")),
    observation_period_end_date = c(as.Date("2011-06-19"),
                        as.Date("2005-11-29"),
                        as.Date("2016-01-02"),
                        as.Date("2011-12-11"),
                        as.Date("2015-06-01"))
  )
  
```

Here we generate a simulated strata table with 5 individuals and 3 different cohort stratas to illustrate the following examples.

```{r, message=FALSE, warning=FALSE, results='hide'}
 strata_cohort <- tibble(
    cohort_definition_id = c(rep("1",3), rep("2", 3), rep("3",5)),
      subject_id = c("1","2","4", "3", "5", "2", "3", "3","5", "5" ,"2"),
    cohort_start_date = c(as.Date("2010-12-19"),
                          as.Date("2005-04-01"),
                          as.Date("2010-08-20"),
                          as.Date("2012-01-01"),
                          as.Date("2010-06-01"),
                          as.Date("2005-08-20"),
                          as.Date("2012-01-01"),
                          as.Date("2015-06-01"),
                          as.Date("2014-10-01"),
                          as.Date("2010-06-01"),
                          as.Date("2005-08-20")),
    cohort_end_date = c(as.Date("2011-06-19"),
                        as.Date("2005-11-29"),
                        as.Date("2011-12-11"),
                        as.Date("2013-01-01"),
                        as.Date("2012-03-01"),
                        as.Date("2005-11-29"),
                        as.Date("2013-01-01"),
                        as.Date("2015-12-31"),
                        as.Date("2015-04-01"),
                        as.Date("2010-06-01"),
                        as.Date("2005-08-20"))
  )

# mock database
cdm <- generate_mock_incidence_prevalence_db(person = person,
                            observation_period = observation_period,
                            strata=strata_cohort)

  
```
### Not applying any subset
We can get a denominator population without including any particular subset like so
```{r, message=FALSE, warning=FALSE}
dpop <- collectDenominatorPops(
    cdm = cdm
  )
  
dpop <- dpop$denominator_pop 
dpop
```
As we did not specify any study start and end date, the cohort start and end date of our 5 patients correspond to the same registered as observation period. 

```{r, message=FALSE, warning=FALSE}
observation_period
```

### Subset based on non-time-varying characteristics
Let's suppose we want to subset our population based on a non-time varying characteristic such as ethnicity, which corresponds to strataCohortId "1" in our simulated strata table.

```{r, message=FALSE, warning=FALSE}
dpop <- collectDenominatorPops(
    cdm = cdm,
    strataTable = "strata",
    strataCohortId = "1",
  )
  
dpop <- dpop$denominator_pop 
dpop
```

We have obtained the 3 patients with the particular ethnicity we were interested in. Moreover, because ethnicity does not change during the study period, the cohort start and end date correspond to same dates of their observation period. Therefore, the obtained denominator population cohort is the same than the one observed in the first example, but it's limited to the individuals that have our characteristic of interest.

```{r, message=FALSE, warning=FALSE}
library(dplyr)
observation_period %>%
  filter(person_id %in% c("1", "2", "4"))
```

### Subset based on time-varying characteristics 
Now we want to subset our population based on a time varying characteristic such a particular condition (strataCohortId "2" in our simulated strata table).

```{r, message=FALSE, warning=FALSE}
dpop <- collectDenominatorPops(
    cdm = cdm,
    strataTable = "strata",
    strataCohortId = "2",
  )
  
dpop <- dpop$denominator_pop 
dpop
```

We have obtained a denominator population with 3 individuals who have experienced this event during their observation period. In this case, the cohort start and end dates correspond to the cohort start and end date of our strata table, and not to their observation period. Therefore, individuals only contribute time while they are experiencing this particular condition. 

```{r, message=FALSE, warning=FALSE}
strata_cohort %>%
  filter(cohort_definition_id == "2") %>%
  filter(subject_id %in% c("2", "3", "5"))
```

Depending in which condition we're interested in, people might experience the same condition multiple times. Let's use strataCohortId "3" to illustrate this example. 

```{r, message=FALSE, warning=FALSE}
dpop <- collectDenominatorPops(
    cdm = cdm,
    strataTable = "strata",
    strataCohortId = "3",
  )
  
dpop <- dpop$denominator_pop 
dpop
```

We can see that person "3" and "5" experienced this condition in two different occasions. Therefore, they only contribute time to the denominator population during the time periods they had this condition. As before, cohort start and end date correspond to the start and end date of this condition.

```{r, message=FALSE, warning=FALSE}
strata_cohort %>%
  filter(cohort_definition_id == "3") %>%
  filter(subject_id %in% c("2", "3", "5"))
```

In both examples, the study period can be restricted to a particular period of interest. Similarly, age and sex stratification and prior history requirements can be further applied.


```{r, message=FALSE, warning=FALSE}
dpop <- collectDenominatorPops(
    cdm = cdm,
    strataTable = "strata",
    strataCohortId = "3",
    startDate = as.Date("2014-01-01"),
    endDate = as.Date("2016-01-01"),
    ageStrata = list(c(0,150)),
    sexStrata = "Female",
    daysPriorHistory = 0)
  
  
dpop <- dpop$denominator_pop 
dpop
```

In this case we have used the same strata than before, but we have restricted our analysis to females and we have limited our study period.As we can see, using this period of time we don't capture patient "2" (who was a man) and we only observe one time period for individuals "3" and "5" (who had multiple contributing time periods in the prior example).


!!To do: Add what happens if there are multiple observation periods per person + multiple outcomes.

