---
title: "a02_Creating denominator populations"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{a02_Creating_denominator_populations}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r, message= FALSE, warning=FALSE, echo=FALSE}
library(here)
library(ggplot2)
library(DBI)
library(dbplyr)
library(dplyr)
library(tibble)
library(tidyr)
library(duckdb)
library(knitr)
#library(IncidencePrevalence)
```

## Introduction
We can use the `collect_denominator_pop()` function to identify the denominator population for a given set of criteria, including age, sex, and prior history requirement. In addition, we can also specify the study period we are interested in.

The `collect_denominator_pop()` function is designed to be called against databases mapped to the OMOP CDM format, as it requires information registered in the person and observation_period tables. It does not require any information on outcome occurrences, as it will be requested in subsequent functions, including `collect_pop_incidence()` and `collect_pop_prevalence()`.

The output of this function consists on a table with information on all the individuals who fulfill the given criteria at any point during the study period. It also includes information on the specific start and end dates in which individuals contributed to the denominator population (cohort_start_date and cohort_end_date). Each patient will be recorded in a different row. For those databases that allow individuals to have multiple non-overlapping observation periods, one row for each patient and observation period will be considered.

## Rationale for contributing time
The number of individuals and the duration of time in which they will be included in the denominator population will depend on their characteristics (as defined in the person and observation_period tables of our OMOP CDM database) and the set of criteria chosen to run the `collect_denominator_pop()` function.

Individuals will be included in the denominator population once they fulfill the age and prior history requirements specified in the function. Individuals will only contribute time during the time period they were present in the database, and therefore observed, within the desired study period.

Index date (cohort_start_date) is defined as the latest of the following: 

1. Study start date
2. Start of observation period  
3. Date in which they turn the minimum age

The end of contribution (cohort_end_date) is defined as the earliest of the following: 
1. Study end date
2. End of observation period
3. Last day in which they have the maximum age

```{r,echo=FALSE, out.width="80%"}
knitr::include_graphics(here("vignettes/denominator_pop_inclusion_fig1.png"))
```

If prior history is required, individuals will be forced to have been present in the database for a specific period of time at index date. If needed, index date will be postponed to fulfill this requirement.

```{r,echo=FALSE, out.width="80%"}
knitr::include_graphics(here("vignettes/denominator_pop_inclusion_fig2.png"))
```

Study start and end date, age and prior history requirements will be defined as part of the `collect_denominator_pop()` function. The start and end of observation period will be obtained from the observation_period table of our OMOP CDM database. 

In addition, individuals can have one or multiple non-overlapping observation periods. The time contribution of each individual will be calculated for each of their observation periods.

```{r,echo=FALSE, out.width="80%"}
knitr::include_graphics(here("vignettes/denominator_pop_inclusion_fig3.png"))
```

## Mock database
Let's say we have a mock database with five hypothetical patients with different observation periods. This database contains the person and observation_period tables in the OMOP CDM format.

The structure of each of these tables is described in detail at: https://ohdsi.github.io/CommonDataModel/cdm53.html

```{r, message=FALSE, warning=FALSE, echo=FALSE, results='hide'}
db <- duckdb::dbConnect(duckdb::duckdb(), ":memory:")
person<-tibble(person_id=c("1", "2", "3", "4", "5"),
               gender_concept_id=c("8507","8507", "8532", "8532", "8507"),
               year_of_birth=c(2000,2010, 2003, 2001, 2012),
               month_of_birth=c(01,10,04,06,11),
               day_of_birth=c(01, 01, 01,01,01))

observation_period<-tibble(observation_period_id=c("1","1", "1","1", "1"),
                           person_id=c("1", "2", "3", "4", "5"),
                           observation_period_start_date=c(as.Date("2010-01-01"),as.Date("2013-10-10"), as.Date("2011-10-01"), as.Date("2013-02-01"), as.Date("2015-04-01")),
                           observation_period_end_date=c(as.Date("2014-06-01"),as.Date("2015-12-31"), as.Date("2015-03-01"), as.Date("2015-11-01"), as.Date("2015-12-31")))

DBI::dbWithTransaction(db, {
  DBI::dbWriteTable(db, "person", person,
                    overwrite = TRUE)
})
DBI::dbWithTransaction(db, {
  DBI::dbWriteTable(db, "observation_period", observation_period,
                    overwrite = TRUE
  )
})
```

```{r}
dbReadTable(db, "person")
dbReadTable(db, "observation_period")
```

We can plot their observation periods:

```{r,echo=FALSE, out.width="60%"}
knitr::include_graphics(here("vignettes/mock_db_fig1.png"))
```

## Arguments
To use the `collect_denominator_pop()` function, connection details and the name of the schema which contains the OMOP CDM person and observation_period tables must be indicated. If the other arguments are not specified, default arguments will be automatically assigned.

Default arguments for this function include no age and no sex stratification, and no prior history requirement. All individuals aged between 0 to 150 years old are included, and results are reported for both sexes. If not provided, study start and end date are considered as the earliest and latest observation start and end date recorded in the observation_period table, respectively. All this information is specified in the output table (age_strata, sex_strata, required_days_prior_history).

```{r}
dpop<-collect_denominator_pops(db=db,
                                cdm_database_schema=NULL)
glimpse(dpop)
```
### Set a study period 
To set a study period, we can specify a study_start_date and a study_end_date. By setting these arguments, individuals will only contribute time to the denominator population during this period of time. 

Given these dates, only four out of our five individuals will contribute to the denominator population.

```{r}
dpop<-collect_denominator_pops(db=db,
                               cdm_database_schema=NULL,
                               study_start_date= as.Date("2012-01-01"),
                               study_end_date= as.Date("2014-12-31"),
                               verbose= FALSE)
glimpse(dpop)
```
```{r,echo=FALSE, out.width="60%"}
knitr::include_graphics(here("vignettes/mock_db_fig2.png"))
```

Study_start_date and study_end_date are also reported in the output table.

### Define age & sex stratifications
We can identify the denominator population for different age groups. To do so, we need to set the argument study_age_stratas indicating the age groups to be considered. For sex, we can set study_sex_stratas with the sex stratification in which results are desired ("Male", "Female", "Both"). 

The number of participants included in the denominator population will depend on the characteristics defined. In this case, only three participants fulfill the age criteria during the study period.

```{r}
dpop_sp<-collect_denominator_pops(db=db,
                                      cdm_database_schema=NULL,
                                      study_start_date= as.Date("2012-01-01"),
                                      study_end_date= as.Date("2014-12-31"),
                                      study_age_stratas=list(c(8,12)),
                                      study_sex_stratas=c("Both"), 
                                      verbose= FALSE)
glimpse(dpop_sp)
```
We can check that the rational for this, computing the age at study_start_date and study_end_date. 
```{r, echo=FALSE}
person_dob <-person %>% filter(person_id !=5)%>%
  mutate(dob=ymd(paste(year_of_birth, month_of_birth, day_of_birth, sep="-")))%>%
  mutate(gender = ifelse(gender_concept_id == "8507", "Male",
        ifelse(gender_concept_id == "8532", "Female", NA)))%>%
  select(person_id, dob, gender)

person_dob <- person_dob %>% 
              mutate(age_start_date = as.numeric(floor((as.Date("2012-01-01") -dob)/365.25)))%>%
              mutate(age_end_date = as.numeric(floor((as.Date("2014-12-31") -dob)/365.25)))%>%
              mutate(age.criteria = ifelse(age_start_date <= 12 & age_end_date >= 8, TRUE, FALSE))
person_dob 

```

Furthermore, if we set study_sex_stratas to Female, our denominator population will be restricted to two participants.

```{r}
dpop_sp<-collect_denominator_pops(db=db,
                                      cdm_database_schema=NULL,
                                      study_start_date= as.Date("2012-01-01"),
                                      study_end_date= as.Date("2014-12-31"),
                                      study_age_stratas=list(c(8,12)),
                                      study_sex_stratas=c("Female"), 
                                      verbose= FALSE)
glimpse(dpop_sp)
```

### Prior history requirement
We can set study_days_prior_history to indicate the number of days of prior history requirement at index date. If a participant does not fulfill this criteria at index date, their inclusion will be postponed until the number of days defined in the study_days_prior_history is achieved.


```{r}
dpop_sp<-collect_denominator_pops(db=db,
                                      cdm_database_schema=NULL,
                                      study_start_date= as.Date("2012-01-01"),
                                      study_end_date= as.Date("2014-12-31"),
                                      study_age_stratas=list(c(8,12)),
                                      study_sex_stratas=c("Female"), 
                                      study_days_prior_history= 180,
                                      verbose= FALSE)
glimpse(dpop_sp)
```

We can check the observation period of these participants in the observation_period table:

```{r, echo=FALSE}
observation_period %>% 
  filter(person_id == "3"|person_id == "4")
```
In this example, we can see that the cohort_start_date of these two patients does not equal the observation_period_start_date reported in the observation_period_table. Given the prior history requirement, cohort_start_date is postponed 180 days following the observation_period_start_date for both cases. Here, study_days_prior_history is plotted in red.

```{r,echo=FALSE, out.width="60%"}
knitr::include_graphics(here("vignettes/mock_db_fig3.png"))
```

### Verbose
We can set verbose=TRUE to report progress as code is running. By default, no progress is reported (verbose=FALSE).

## Multiple options
More than one age, sex and prior history requirements can be specified at the same time. Overlapping of different age groups is allowed. 

```{r}
dpop_sp<-collect_denominator_pops(db=db,
                                      cdm_database_schema=NULL,
                                      study_start_date= as.Date("2012-01-01"),
                                      study_end_date= as.Date("2014-12-31"),
                                      study_age_stratas=list(c(0,10), c(8,12)),
                                      study_sex_stratas=c("Male", "Female", "Both"), 
                                      study_days_prior_history= c(0,180),
                                      verbose= FALSE)
glimpse(dpop_sp)
```
A specific denominator population will be created for each combination of requirements. In this case, we have: 2 age groups, 2 prior history requirements and 3 sex categories, which result in 12 different denominator populations. 

```{r,echo=FALSE}
options <-expand.grid(dpop_sp%>%select(age_strata)%>% distinct()%>%pull(),
             dpop_sp%>%select(sex_strata)%>%distinct()%>%pull(),
             dpop_sp%>%select(required_days_prior_history)%>%distinct()%>%pull()
            )%>%
          rename(age_strata=Var1)%>%
          rename(sex_strata=Var2)%>%
          rename(required_prior_history=Var3)
options
```

### Alternative to identify denominator populations
This package allows the user to identify the denominator population without the need to used the `collect_denominator_pop()` function. Therefore,`collect_pop_incidence()` and `collect_pop_prevalence()`functions can be used against populations not created with the`collect_denominator_pop()`function. 

If the user prefers to do so, he/she can create a dataframe containing the denominator population of interest. Individuals included in this dataframe can be identified by bespoke code or by other OHDSI tools such as ATLAS.

However, the structure of the dataframe containing the denominator population must be the same that the one created by `collect_denominator_pop()`, and must include the following columns:

```{r, fig.show='hold', echo=FALSE, warning=FALSE}
colnames(dpop)
```
