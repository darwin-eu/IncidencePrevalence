---
title: "Creating denominator populations"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{a02_Creating_denominator_populations}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 7,
  fig.height = 5,
  eval = Sys.getenv("$RUNNER_OS") != "macOS"
)
```

```{r, message= FALSE, warning=FALSE, echo=FALSE}
library(here)
library(ggplot2)
library(DBI)
library(dbplyr)
library(dplyr)
library(tibble)
library(tidyr)
library(duckdb)
library(knitr)
library(IncidencePrevalence)
```

# Introduction
Calculating incidence or prevalence requires first identifying an appropriate denominator population. To find such a denominator population (or multiple denominator populations) we can use the `generateDenominatorCohortSet()` function. This function will identify the time that people satisfy a set of criteria related to the study period and individuals´ age, sex, and amount of prior observed history. 

The `generateDenominatorCohortSet()` function is designed to be used with data mapped to the OMOP CDM format. Unless otherwise specified (see the next vignette "Creating denominator population using a cohort"), it will use information from the person and observation_period tables of the OMOP CDM to identify denominator populations. To note, identifying the denominator population does not require any information on specific outcome occurrences. 

When using `generateDenominatorCohortSet()`, individuals will enter a denominator population on the respective date of the latest of the following: 

1. Study start date
2. Date at which they have sufficient prior history (if there is no requirement for prior history, this date will coincide with the date at which their observation period starts)  
3. Date at which they reach a minimum age

They will then exit on the respective date of the earliest of the following: 
1. Study end date
2. Date at which their observation period ends
3. The last day in which they have the maximum age


Let´s go through a few examples to make this a little more concrete.

### No specific requirements
The simplest case is that no study start and end dates are specified, no prior history requirement is imposed, nor any age or sex criteria. In this case individuals will enter the denominator population once they have entered the database (start of observation period) and will leave when they exit the database (end of observation period). Note that in some databases a person can have multiple observation periods, in which case their contribution of person time would look like the the last person below.

```{r,echo=FALSE, out.width="80%"}
knitr::include_graphics(here("vignettes/dpop1.png"))
```

### Specified study period
If we specify a study start and end date then only observation time during this period will be included.

```{r,echo=FALSE, out.width="80%"}
knitr::include_graphics(here("vignettes/dpop2.png"))
```

### Specified study period and prior history requirement
If we also add some requirement of prior history then somebody will only contribute time at risk once this is reached.

```{r,echo=FALSE, out.width="80%"}
knitr::include_graphics(here("vignettes/dpop3.png"))
```


### Specified study period, prior history requirement, and age and sex criteria

Lastly we can also impose age and sex criteria, and now individuals will only contribute time when they also satisfy these criteria. Not shown in the below figure is a person´s sex, but we could also stratify a denominator population by this as well.

```{r,echo=FALSE, out.width="80%"}
knitr::include_graphics(here("vignettes/dpop4.png"))
```

# Using generateDenominatorCohortSet()
`generateDenominatorCohortSet()` is the function we use to identify a set of denominator populations. To demonstrate its use, let´s load the IncidencePrevalence package (along with a couple of packages to help for subsequent plots) and generate 500 example patients using the `mockIncidencePrevalenceRef()` function.

```{r, message=FALSE, warning=FALSE, results='hide'}
library(IncidencePrevalence)
library(ggplot2)
library(tidyr)

cdm <- mockIncidencePrevalenceRef(sampleSize = 500)
```


### No specific requirements

We can get a denominator population without including any particular requirements like so

```{r, message=FALSE, warning=FALSE}
dpop <- generateDenominatorCohortSet(
  cdm = cdm,
  startDate = NULL,
  endDate = NULL,
  ageGroups = list(c(0, 150)),
  sex = "Both",
  daysPriorHistory = 0
)
dpop$denominator_population %>% glimpse()

dpop$denominator_population %>%
  filter(subject_id %in% c("1", "2", "3", "4", "5"))
```

Let´s have a look at the included time of the first five patients

```{r, message=FALSE, warning=FALSE}
dpop$denominator_population %>%
  collect() %>%
  filter(subject_id %in% c("1", "2", "3", "4", "5")) %>%
  pivot_longer(cols = c(
    "cohort_start_date",
    "cohort_end_date"
  )) %>%
  ggplot() +
  geom_point(aes(x = value, y = subject_id)) +
  geom_line(aes(x = value, y = subject_id)) +
  theme_minimal() +
  xlab("Year")
```

We can also plot a histogram of start and end dates of the 500 simulated patients 
```{r, message=FALSE, warning=FALSE}
dpop$denominator_population %>%
  collect() %>%
  ggplot() +
  theme_minimal() +
  geom_histogram(aes(cohort_start_date),
    colour = "black", fill = "grey"
  )
```

```{r, message=FALSE, warning=FALSE}
dpop$denominator_population %>%
  collect() %>%
  ggplot() +
  theme_minimal() +
  geom_histogram(aes(cohort_end_date),
    colour = "black", fill = "grey"
  )
```

### Specified study period
We can get specify a study period like so

```{r, message=FALSE, warning=FALSE}
dpop <- generateDenominatorCohortSet(
  cdm = cdm,
  startDate = as.Date("2008-01-01"),
  endDate = as.Date("2010-01-01"),
  ageGroups = list(c(0, 150)),
  sex = "Both",
  daysPriorHistory = 0
)
dpop$denominator_population %>%
  glimpse()

dpop$denominator_population %>%
  filter(subject_id %in% c("1", "2", "3", "4", "5"))
```

Now we can see the person "2", "4" and "5" haven´t been included as they don´t have any observation time during the study period. Indeed, we´re now including 328 of the original 500 simulated patients.

```{r, message=FALSE, warning=FALSE}
dpop$denominator_population %>%
  filter(subject_id %in% c("1", "2", "3", "4", "5")) %>%
  collect() %>%
  pivot_longer(cols = c(
    "cohort_start_date",
    "cohort_end_date"
  )) %>%
  ggplot() +
  geom_point(aes(x = value, y = subject_id)) +
  geom_line(aes(x = value, y = subject_id)) +
  theme_minimal() +
  xlab("Year")
```

We can also plot a histogram of start and end dates and we can see that now most people enter at the start of the study period and leave at the end.
```{r, message=FALSE, warning=FALSE}
dpop$denominator_population %>%
  collect() %>%
  ggplot() +
  theme_minimal() +
  geom_histogram(aes(cohort_start_date),
    colour = "black", fill = "grey"
  )
```

```{r, message=FALSE, warning=FALSE}
dpop$denominator_population %>%
  collect() %>%
  ggplot() +
  theme_minimal() +
  geom_histogram(aes(cohort_end_date),
    colour = "black", fill = "grey"
  )
```


### Specified study period and prior history requirement
We can add some requirement of prior history

```{r, message=FALSE, warning=FALSE}
dpop <- generateDenominatorCohortSet(
  cdm = cdm,
  startDate = as.Date("2008-01-01"),
  endDate = as.Date("2010-01-01"),
  ageGroups = list(c(0, 150)),
  sex = "Both",
  daysPriorHistory = 365
)
dpop$denominator_population %>%
  glimpse()

dpop$denominator_population %>%
  filter(subject_id %in% c("1", "2", "3", "4", "5"))
```

Now we only include patient "1" of the original first five and we´re now including 178 of the original 500 simulated patients.

```{r, message=FALSE, warning=FALSE}
dpop$denominator_population %>%
  filter(subject_id %in% c("1", "2", "3", "4", "5")) %>%
  collect() %>%
  pivot_longer(cols = c(
    "cohort_start_date",
    "cohort_end_date"
  )) %>%
  ggplot() +
  geom_point(aes(x = value, y = subject_id)) +
  geom_line(aes(x = value, y = subject_id)) +
  theme_minimal() +
  xlab("Year")
```

With the histograms of start and end dates now looking like
```{r, message=FALSE, warning=FALSE}
dpop$denominator_population %>%
  collect() %>%
  ggplot() +
  theme_minimal() +
  geom_histogram(aes(cohort_start_date),
    colour = "black", fill = "grey"
  )
```

```{r, message=FALSE, warning=FALSE}
dpop$denominator_population %>%
  collect() %>%
  ggplot() +
  theme_minimal() +
  geom_histogram(aes(cohort_end_date),
    colour = "black", fill = "grey"
  )
```

### Specified study period, prior history requirement, and age and sex criteria
In addition to all the above we could also add some requirements around age and sex. One thing to note is that the age upper limit will include time from a person up to the day before their reach the age upper limit + 1 year. For instance, when the upper limit is 65, that means we will include time from a person up to and including the day before their 66th birthday.

```{r, message=FALSE, warning=FALSE}
dpop <- generateDenominatorCohortSet(
  cdm = cdm,
  startDate = as.Date("2008-01-01"),
  endDate = as.Date("2010-01-01"),
  ageGroups = list(c(18, 65)),
  sex = "Female",
  daysPriorHistory = 365
)
dpop$denominator_population %>%
  glimpse()

dpop$denominator_population %>%
  filter(subject_id %in% c("1", "2", "3", "4", "5"))
```

Now none of the original first five are included and we´re including 48 of the original 500 simulated patients.

The histograms of start and end dates now looking like
```{r, message=FALSE, warning=FALSE}
dpop$denominator_population %>%
  collect() %>%
  ggplot() +
  theme_minimal() +
  geom_histogram(aes(cohort_start_date),
    colour = "black", fill = "grey"
  )
```

```{r, message=FALSE, warning=FALSE}
dpop$denominator_population %>%
  collect() %>%
  ggplot() +
  theme_minimal() +
  geom_histogram(aes(cohort_end_date),
    colour = "black", fill = "grey"
  )
```

### Multiple options to return multiple denominator populations 
More than one age, sex and prior history requirements can be specified at the same time. First, we can take a look at having two age groups. We can see below that those individuals who have their 41st birthday during the study period will go from the first cohort (age_group: 0;40) to the second (age_group: 41;100) on this day.
```{r, message=FALSE, warning=FALSE}
dpop <- generateDenominatorCohortSet(
  cdm = cdm,
  startDate = as.Date("2008-01-01"),
  endDate = as.Date("2010-01-01"),
  ageGroups = list(
    c(0, 40),
    c(41, 100)
  ),
  sex = "Both",
  daysPriorHistory = 0
)
dpop <- dpop$denominator_population %>%
  collect() %>%
  left_join(dpop$denominator_settings)

dpop %>%
  glimpse()

dpop %>%
  group_by(cohort_definition_id, age_group) %>%
  tally()

dpop %>%
  filter(subject_id %in% c("1", "3", "57", "353", "393", "496")) %>%
  collect() %>%
  pivot_longer(cols = c(
    "cohort_start_date",
    "cohort_end_date"
  )) %>%
  ggplot(aes(x = subject_id, y = value, colour = cohort_definition_id)) +
  geom_point(position = position_dodge(width = 0.5)) +
  geom_line(position = position_dodge(width = 0.5)) +
  theme_minimal() +
  theme(legend.position = "top") +
  ylab("Year") +
  coord_flip()
```

We can then also 
```{r, message=FALSE, warning=FALSE, fig.height=8}
dpop <- generateDenominatorCohortSet(
  cdm = cdm,
  startDate = as.Date("2008-01-01"),
  endDate = as.Date("2010-01-01"),
  ageGroups = list(
    c(0, 40),
    c(41, 100)
  ),
  sex = c("Male", "Female", "Both"),
  daysPriorHistory = 0
)
dpop <- dpop$denominator_population %>%
  collect() %>%
  left_join(dpop$denominator_settings)

dpop %>% glimpse()

dpop %>%
  group_by(cohort_definition_id, age_group, sex) %>%
  tally()

dpop %>%
  filter(subject_id %in% c("1", "3", "57", "353", "393", "496")) %>%
  pivot_longer(cols = c(
    "cohort_start_date",
    "cohort_end_date"
  )) %>%
  ggplot(aes(x = subject_id, y = value, colour = cohort_definition_id)) +
  facet_grid(sex ~ ., space = "free_y") +
  geom_point(position = position_dodge(width = 0.5)) +
  geom_line(position = position_dodge(width = 0.5)) +
  theme_bw() +
  theme(legend.position = "top") +
  ylab("Year") +
  coord_flip()
```


And then also specifying multiple prior history requirements 
```{r, message=FALSE, warning=FALSE, fig.height=10}
dpop <- generateDenominatorCohortSet(
  cdm = cdm,
  startDate = as.Date("2008-01-01"),
  endDate = as.Date("2010-01-01"),
  ageGroups = list(
    c(0, 40),
    c(41, 100)
  ),
  sex = c("Male", "Female", "Both"),
  daysPriorHistory = c(0, 365)
)
dpop <- dpop$denominator_population %>%
  collect() %>%
  left_join(dpop$denominator_settings)

dpop %>% glimpse()

dpop %>%
  group_by(cohort_definition_id, age_group, sex, days_prior_history) %>%
  tally()

dpop %>%
  filter(subject_id %in% c("1", "3", "57", "353", "393", "496")) %>%
  pivot_longer(cols = c(
    "cohort_start_date",
    "cohort_end_date"
  )) %>%
  ggplot(aes(x = subject_id, y = value, colour = cohort_definition_id)) +
  facet_grid(sex + days_prior_history ~ ., space = "free_y") +
  geom_point(position = position_dodge(width = 0.5)) +
  geom_line(position = position_dodge(width = 0.5)) +
  theme_bw() +
  theme(legend.position = "top") +
  ylab("Year") +
  coord_flip()
```

### Verbose
We can set verbose=TRUE to report progress as code is running. By default, no progress is reported (verbose=FALSE). 

```{r, message=TRUE, warning=FALSE}
dpop <- generateDenominatorCohortSet(
  cdm = cdm,
  startDate = as.Date("2008-01-01"),
  endDate = as.Date("2010-01-01"),
  ageGroups = list(
    c(0, 40),
    c(41, 100)
  ),
  sex = c("Male", "Female", "Both"),
  daysPriorHistory = c(0, 365),
  verbose = TRUE
)
```

### Output 
The output of this function consists on a list of three tibbles.

1) Denominator population
2) Denominator settings
3) Attrition

The denominator population includes the information on all the individuals who fulfill the given criteria at any point during the study period. It also includes information on the specific start and end dates in which individuals contributed to the denominator population (cohort_start_date and cohort_end_date). Each patient is recorded in a different row. For those databases that allow individuals to have multiple non-overlapping observation periods, one row for each patient and observation period is considered.

Considering the following example, we can see:

```{r, message=TRUE, warning=FALSE}
dpop <- generateDenominatorCohortSet(
  cdm = cdm,
  startDate = as.Date("2008-01-01"),
  endDate = as.Date("2010-01-01"),
  ageGroups = list(
    c(0, 18),
    c(19, 100)
  ),
  sex = c("Male", "Female"),
  daysPriorHistory = c(0, 365)
)

head(dpop$denominator_populations, 8)
```

The denominator settings will report the characteristics of the denominator populations created as a result of running this function. More than one age, sex and prior history requirements can be specified at the same time. Therefore, each combination of these variables will result in a different cohort, which be analyzed and identified with a unique cohort_definition_id. This tibble includes information on the study start and end dates, and its characteristics in terms of age and sex groups and the amount of prior history required.

In this example, we have 8 different cohorts.

```{r, message=TRUE, warning=FALSE}
dpop$denominator_settings
```

The attrition list includes information on the number of individuals who are excluded of the denominator population and the reason behind its exclusion, such as missing crucial information or not satisfying the sex or age criteria required, among others. 

In this example we only show the attrition list for the first cohort, but it's generated for every cohort of our analysis (in this case, eight).

```{r, message=TRUE, warning=FALSE}
head(dpop$attrition, 8)
```


To do: Add information about attrition for incidence 

### Creating a denominator population using a cohort
The `generateDenominatorCohortSet()` function can also be run for a subset of the population with a particular characteristic recorded in our database, such as sociodemographic groups (ethnicity, socioeconomic status...), conditions or users of a particular medication, among others. This feature is further explained in the next vignette (see the vignette "Creating denominator population using a cohort"). 
