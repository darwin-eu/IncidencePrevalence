---
title: "Calculating incidence"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{a06_Calculating_incidence}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 7, 
  fig.height = 5
)
```


```{r, message= FALSE, warning=FALSE, echo=FALSE}
library(here)
library(ggplot2)
library(DBI)
library(dbplyr)
library(dplyr)
library(tibble)
library(tidyr)
library(duckdb)
library(knitr)
library(IncidencePrevalence)
```

# Introduction
Incidence rates describe the rate at which new events occur in a population, with the denominator the person-time at risk of the event during this period. In the previous vignettes we have seen how we can identify a denominator population and define and instantiate an outcome cohort. Incidence rates can then be calculated using time contributed from the denominator population up to their entry in the outcome cohort.

There are a number of options to consider when calculating incidence rates. 

outcome_washout_window
repetitive_events


### No washout, no repetitive events
In this example there is no outcome washout specified and repetitive events are not allowed, so individuals contribute time up to their first event during the study period.
```{r,echo=FALSE, out.width="80%"}
knitr::include_graphics(here("vignettes/inc_no_rep_no_washout.png"))
```

### Washout all history, no repetitive events
In this example the outcome washout is all history and repetitive events are not allowed. As before individuals contribute time up to their first event during the study period, but having an outcome prior to the study period (such as person "3") means that no time at risk is contributed. 

```{r,echo=FALSE, out.width="80%"}
knitr::include_graphics(here("vignettes/inc_no_rep_washout_all.png"))
```

### Some washout, no repetitive events
In this example there is some amount of outcome washout and repetitive events are not allowed. As before individuals contribute time up to their first event during the study period, but having an outcome prior to the study period (such as person "3") means that time at risk is only contributed once sufficient time has passed for the outcome washout criteria to have been satisfied.

```{r,echo=FALSE, out.width="80%"}
knitr::include_graphics(here("vignettes/inc_no_rep_some_washout.png"))
```

### Some washout, repetitive events
Now repetitive events are allowed with some amount of outcome washout specified. So individuals contribute time up to their first event during the study period, and then after passing the outcome washout requirement they begin to contribute time at risk again.

```{r,echo=FALSE, out.width="80%"}
knitr::include_graphics(here("vignettes/inc_rep_some_washout.png"))
```


# Using collect_pop_incidence()
`collect_pop_incidence()` is the function we use to estimate incidence rates To demonstrate its use, let´s load the IncidencePrevalence package (along with a couple of packages to help for subsequent plots) and generate 50,000 example patients using the `generate_mock_incidence_prevalence_db()` function, from whom we´ll create a denominator population without adding any restrictions other than a study period.

```{r setup}
library(IncidencePrevalence)
library(dplyr)
library(tidyr)
library(ggplot2)

cdm_ref <- generate_mock_incidence_prevalence_db(sample_size=50000,
                                          out_pre=0.5)

dpop <- collect_denominator_pops(cdm_ref = cdm_ref,
                                 study_start_date = as.Date("2008-01-01"),
                                 study_end_date = as.Date("2012-01-01"),
                                 study_age_stratas = NULL,
                                 study_sex_stratas = "Both",
                                 study_days_prior_history = 0)
dpop<-dpop$denominator_population 

dpop %>%  
  glimpse()
```

Let´s first calculate incidence rates on a yearly basis, without allowing repetitive events
```{r, message= FALSE, warning=FALSE}
inc <- collect_pop_incidence(
  cdm_ref = cdm_ref,
  results_schema_outcomes = NULL,
  table_name_outcomes = "outcome",
  cohort_ids_outcomes = "1",
  cohort_ids_denominator_pops = "1",
  study_denominator_pop = dpop,
  time_intervals = c("Years"),
  outcome_washout_windows = 0,
  repetitive_events = FALSE
)

inc$incidence_estimates %>%  
  glimpse()

inc$incidence_estimates %>% 
  ggplot(aes(start_time, ir_100000_pys))+
  geom_point()+
  scale_y_continuous(limits = c(0,NA))+
  theme_minimal()
```

Now with a washout of all prior history while still not allowing repetitive events
```{r, message= FALSE, warning=FALSE}
inc <- collect_pop_incidence(
  cdm_ref = cdm_ref,
  results_schema_outcomes = NULL,
  table_name_outcomes = "outcome",
  cohort_ids_outcomes = "1",
  cohort_ids_denominator_pops = "1",
  study_denominator_pop = dpop,
  time_intervals = c("Years"),
  outcome_washout_windows = NULL,
  repetitive_events = FALSE
)

inc$incidence_estimates %>%  
  glimpse()

inc$incidence_estimates %>% 
  ggplot(aes(start_time, ir_100000_pys))+
  geom_point()+
  scale_y_continuous(limits = c(0,NA))+
  theme_minimal()
```

Now we´ll set the washout to 180 days while still not allowing repetitive events
```{r, message= FALSE, warning=FALSE}
inc <- collect_pop_incidence(
  cdm_ref = cdm_ref,
  results_schema_outcomes = NULL,
  table_name_outcomes = "outcome",
  cohort_ids_outcomes = "1",
  cohort_ids_denominator_pops = "1",
  study_denominator_pop = dpop,
  time_intervals = c("Years"),
  outcome_washout_windows = 180,
  repetitive_events = FALSE
)

inc$incidence_estimates %>%  
  glimpse()

inc$incidence_estimates %>% 
  ggplot(aes(start_time, ir_100000_pys))+
  geom_point()+
  scale_y_continuous(limits = c(0,NA))+
  theme_minimal()
```

And finally we´ll set the washout to 180 days and allow repetitve events
```{r, message= FALSE, warning=FALSE}
inc <- collect_pop_incidence(
  cdm_ref = cdm_ref,
  results_schema_outcomes = NULL,
  table_name_outcomes = "outcome",
  cohort_ids_outcomes = "1",
  cohort_ids_denominator_pops = "1",
  study_denominator_pop = dpop,
  time_intervals = c("Years"),
  outcome_washout_windows = 180,
  repetitive_events = TRUE
)

inc$incidence_estimates %>%  
  glimpse()

inc$incidence_estimates %>% 
  ggplot(aes(start_time, ir_100000_pys))+
  geom_point()+
  scale_y_continuous(limits = c(0,NA))+
  theme_minimal()
```
