---
title: "Introduction to IncidencePrevalence"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{a01_Introduction_to_IncidencePrevalence}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 7,
  fig.height = 5,
  eval = Sys.getenv("$RUNNER_OS") != "macOS"
)
```

To do a study of incidence and prevalence, there are four core analytics functions from this package that you would interact with

1)  `generateDenominatorCohortSet()` - this function will identify a set of denominator populations that can be used for calculations of prevalence and incidence
2)  `estimatePointPrevalence()` - this function will estimate point prevalence for outcomes among denominator populations
3)  `estimatePeriodPrevalence()` - this function will estimate period prevalence for outcomes among denominator populations
4)  `estimateIncidence()` - this function will estimate incidence rates for outcomes among denominator populations

Below, we show an example analysis to provide an broad overview of how this functionality provided by the IncidencePrevalence package can be used. More context and further examples for each of these functions are provided in later vignettes.

First, let's load relevant libraries.
```{r, message= FALSE, warning=FALSE}
library(CDMConnector)
library(IncidencePrevalence)
library(dplyr)
library(tidyr)
library(ggplot2)
```

The IncidencePrevalence package works with data mapped to the OMOP CDM and we will first need to connect to a database, after which we can use the CDMConnector package to represent our mapped data as a single R object. This could like something like:

```{r eval=FALSE}
con <- DBI::dbConnect(RPostgres::Postgres(),
                      dbname = Sys.getenv("CDM5_POSTGRESQL_DBNAME"),
                      host = Sys.getenv("CDM5_POSTGRESQL_HOST"),
                      user = Sys.getenv("CDM5_POSTGRESQL_USER"),
                      password = Sys.getenv("CDM5_POSTGRESQL_PASSWORD"))
cdm <- CDMConnector::cdm_from_con(con, 
                                  cdm_schema = Sys.getenv("CDM5_POSTGRESQL_CDM_SCHEMA"))
```

For this example though weÂ´ll generate 50,000 hypothetical patients using the `mockIncidencePrevalenceRef()` function. 
```{r, message= FALSE, warning=FALSE}
cdm <- mockIncidencePrevalenceRef(
  sampleSize = 50000,
  outPre = 0.5
)
```

Importantly this example data already includes an outcome cohort. In practice, study-specific outcome cohorts of interest will need to be created. If the outcome cohorts are defined as JSON, we can use the CDMConnector package to read in and generate the cohorts.

```{r eval=FALSE}
outcome_cohorts <- CDMConnector::readCohortSet(here::here("outcome_cohorts"))
cdm <- CDMConnector::generateCohortSet(cdm, 
                                       outcome_cohorts,
                                       cohortTableName = outcome_table)
```

Once we have a connection to the database set-up, we can use the `generateDenominatorCohortSet()` to identify a denominator cohort to use later when calculating incidence and prevalence. In this case we identify one for those aged between 18 and 65 between 2008 and 2012, who were female, and had 365 days of prior history available.

```{r, message= FALSE, warning=FALSE}
cdm$denominator <- generateDenominatorCohortSet(
  cdm = cdm,
  startDate = as.Date("2008-01-01"),
  endDate = as.Date("2012-01-01"),
  ageGroup = list(c(18, 65)),
  sex = "Female",
  daysPriorHistory = 365
)
```

We can see that the denominator cohort is in the same format as OMOP CDM cohorts:
```{r}
cdm$denominator %>%
  glimpse()
```

We can also see that we have created a single cohort associated with the following settings:
```{r}
settings(cdm$denominator) 
```

Now that we have our denominator population, and using the outcome cohort that was also generated by the `mockIncidencePrevalenceRef()` function, we can estimate prevalence using the `estimatePointPrevalence()` function. Here we calculate point prevalence on a yearly basis.

```{r, message= FALSE, warning=FALSE}
prev <- estimatePeriodPrevalence(
  cdm = cdm,
  denominatorTable = "denominator",
  outcomeTable = "outcome",
  interval = "quarters",
  minCellCount = 0
)

prev %>%
  glimpse()

prev %>%
  ggplot(aes(x = prevalence_start_date, y=prevalence,
             ymin = prevalence_95CI_lower,
             ymax = prevalence_95CI_upper)) +
  geom_point() +
  geom_errorbar(width=0) +
  scale_y_continuous(
    labels = scales::percent,
    limits = c(0, 0.3)
  ) +
  theme_minimal()
```

Similarly we can use the `estimateIncidence()` function to estimate incidence rates. Here we annual incidence rates, with 180 days used for outcome washout windows.

```{r, message= FALSE, warning=FALSE}
inc <- estimateIncidence(
  cdm = cdm,
  denominatorTable = "denominator",
  outcomeTable = "outcome",
  interval = c("Years"),
  outcomeWashout = 180
)

inc %>%
  glimpse()

inc %>%
  ggplot(aes(x = incidence_start_date, y = ir_100000_pys,
             ymin = ir_100000_pys_95CI_lower,
             ymax = ir_100000_pys_95CI_upper)) +
  geom_point() +
  geom_errorbar(width=0) +
  scale_y_continuous(limits = c(0, NA)) +
  theme_minimal()
```

Once we have our estimates, we can use `gatherIncidencePrevalenceResults()` to bring together the results, adding outcome names and the database name to the output.
```{r}
study_results <- gatherIncidencePrevalenceResults(
                    resultList=list(inc, prev),
                    outcomeCohortId = 1,
                    outcomeCohortName = "example_outcome",
                    databaseName = "example_data")
dplyr::glimpse(study_results$incidence_estimates)
dplyr::glimpse(study_results$prevalence_estimates)
```

After gathering results, we can export them as CSVs in a zip folder using the `exportIncidencePrevalenceResults()` function. 
```{r, eval=FALSE}
exportIncidencePrevalenceResults(result=study_results, 
                  zipName="example_results",
                  outputFolder=here::here()) 
```
