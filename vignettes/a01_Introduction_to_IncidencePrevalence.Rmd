---
title: "Introduction to IncidencePrevalence"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{a01_Introduction_to_IncidencePrevalence}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 7,
  fig.height = 5
)
```

To do a study of incidence and prevalence, there are three functions from this package that you would interact with

1)  `collectDenominatorPops()` - this function will identify a set of denominator populations that can be used for calculations of prevalence and incidence
2)  `collectPopPrevalence()` - this function will estimate prevalence (point or period) for outcomes among denominator populations
3)  `collectPopIncidence()` - this function will estimate incidence rates for outcomes among denominator populations

Note, defining and instantiating outcome cohorts are outside the scope of this package. This will need to be done prior to using the `collectPopPrevalence()` or `collectPopIncidence()`.

Below, we show an example to provide an broad overview of the functionality provided by the IncidencePrevalence package. More context and further examples for each of these functions are provided in later vignettes.

To have some data to work with, after loading the IncidencePrevalence package (along with a couple of packages to help for subsequent plots) weÂ´ll generate 50,000 hypothetical patients using the `generate_mock_incidence_prevalence_db()` function.

```{r, message= FALSE, warning=FALSE}
library(IncidencePrevalence)
library(dplyr)
library(tidyr)
library(ggplot2)

cdm <- mockIncidencePrevalenceRef(
  sampleSize = 50000,
  outPre = 0.5
)
```

We can use the `collectDenominatorPops()` to identify a denominator population between 2008 and 2012 of those aged between 18 and 65, Female, and with 365 days of prior history available.

```{r, message= FALSE, warning=FALSE}
dpop <- collectDenominatorPops(
  cdm = cdm,
  startDate = as.Date("2008-01-01"),
  endDate = as.Date("2012-01-01"),
  ageStrata = list(c(18, 65)),
  sexStrata = "Female",
  daysPriorHistory = 365
)
dpop$denominator_population %>%
  glimpse()
dpop$denominator_settings %>%
  glimpse()
```

We can now add the denominator cohort to our cdm reference.
```{r}
cdm$denominator <- dpop$denominator_population
```

Now that we have our denominator population and using the outcome cohort that was also generated by the `generate_mock_incidence_prevalence_db()` function, we can estimate prevalence using the `collectPopPrevalence()` function. Here we calculate point prevalence on a yearly basis.

```{r, message= FALSE, warning=FALSE}
prev <- collectPopPrevalence(
  cdm = cdm,
  denominatorTable = "denominator",
  outcomesTable = "outcome",
  interval = "Years",
  type = "point",
  minCellCount = 0
)

prev$prevalence_estimates %>%
  glimpse()

prev$prevalence_estimates %>%
  ggplot(aes(start_time, prev)) +
  geom_point() +
  scale_y_continuous(
    labels = scales::percent,
    limits = c(0, NA)
  ) +
  theme_minimal()
```

Similarly we can use the `collectPopIncidence()` function to estimate incidence rates. Here we annual incidence rates, with 180 days used for outcome washout windows.

```{r, message= FALSE, warning=FALSE}
inc <- collectPopIncidence(
  cdm = cdm,
  denominatorTable = "denominator",
  outcomesTable = "outcome",
  interval = c("Years"),
  outcomeWashout = 180
)

inc$incidence_estimates %>%
  glimpse()

inc$incidence_estimates %>%
  ggplot(aes(start_time, ir_100000_pys)) +
  geom_point() +
  scale_y_continuous(limits = c(0, NA)) +
  theme_minimal()
```
