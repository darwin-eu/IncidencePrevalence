---
title: "Calculating prevalence"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{a05_Calculating_prevalence}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width=7, 
  fig.height=5
)
```

```{r, message= FALSE, warning=FALSE, echo=FALSE}
library(here)
library(ggplot2)
library(DBI)
library(dbplyr)
library(dplyr)
library(tibble)
library(tidyr)
library(duckdb)
library(knitr)
library(IncidencePrevalence)
```

# Introduction
Prevalence is the total number of people with an ongoing health-related event, such as a medical condition or medication use, at a particular time or during a given period divided by the population at risk. In the previous vignettes we have seen how we can identify a denominator population and define and instantiate an outcome cohort. Prevalence then can be calculated to describe the proportion of people in the denominator population who are in the outcome cohort at a specified time point (point prevalence) or over a given time interval (period prevalence).

In the first plot below, we can We can see at time t+2 that 2 out of 5 people were in an outcome cohort, giving a point prevalence of 40%. In the second figure, period prevalence between t+2 and t+3 was also 40%. However for period prevalence between t and t+1, what do we do with those people who only contributed some time during the period? If we included them we´ll have a period prevalence of 20%, whereas if we require that everyone is observed for the full period to contribute then we´ll have a period prevalence of 33%.  

```{r,echo=FALSE, out.width="80%"}
knitr::include_graphics(here("vignettes/point_prev.png"))
```

```{r,echo=FALSE, out.width="80%"}
knitr::include_graphics(here("vignettes/period_prev.png"))
```

# Using collect_pop_prevalence()
`collect_pop_prevalence()` is the function we use to estimate prevalence. To demonstrate its use, let´s load the IncidencePrevalence package (along with a couple of packages to help for subsequent plots) and generate 50,000 example patients using the `generate_mock_incidence_prevalence_db()` function, from whom we´ll create a denominator population without adding any restrictions other than a study period.

```{r setup}
library(IncidencePrevalence)
library(dplyr)
library(tidyr)
library(ggplot2)

db<-generate_mock_incidence_prevalence_db(sample_size=50000,
                                          out_pre=0.5)

dpop <- collect_denominator_pops(db = db,
                                 cdm_database_schema = NULL,
                                 study_start_date= as.Date("2008-01-01"),
                                 study_end_date= as.Date("2012-01-01"),
                                 study_age_stratas = NULL,
                                 study_sex_stratas = "Both",
                                 study_days_prior_history = 0)
dpop<-dpop$denominator_population 
dpop %>%  
  glimpse()
```

Let´s first calculate point prevalence on a yearly basis.
```{r, message= FALSE, warning=FALSE}
prev <- collect_pop_prevalence(
  db = db,
  results_schema_outcome = NULL,
  table_name_outcomes = "outcome",
  cohort_ids_outcomes = "1",
  cohort_ids_denominator_pops = "1",
  study_denominator_pop = dpop,
  time_intervals="Years",
  type = "point",
  minimum_cell_count = 0
)

prev$prevalence_estimates  %>%  
  glimpse()

prev$prevalence_estimates %>% 
  ggplot(aes(time, prev))+
  geom_point()+
  scale_y_continuous(labels = scales::percent,
                     limits = c(0,NA))+
  theme_minimal()

```

We can also calculate point prevalence by calendar month
```{r, message= FALSE, warning=FALSE}
prev <- collect_pop_prevalence(
  db = db,
  results_schema_outcome = NULL,
  table_name_outcomes = "outcome",
  cohort_ids_outcomes = "1",
  cohort_ids_denominator_pops = "1",
  study_denominator_pop = dpop,
  time_intervals="Months",
  type = "point",
  minimum_cell_count = 0
)

prev$prevalence_estimates  %>%  
  glimpse()

prev$prevalence_estimates %>% 
  ggplot(aes(start_time, prev))+
  geom_point()+
  scale_y_continuous(labels = scales::percent,
                     limits = c(0,NA))+
  theme_minimal()

```

To calculate period prevalence by year (i.e. each period is a calendar year)
```{r, message= FALSE, warning=FALSE}
prev <- collect_pop_prevalence(
  db = db,
  results_schema_outcome = NULL,
  table_name_outcomes = "outcome",
  cohort_ids_outcomes = "1",
  cohort_ids_denominator_pops = "1",
  study_denominator_pop = dpop,
  time_intervals="Years",
  type = "period",
  minimum_cell_count = 0
)

prev$prevalence_estimates  %>%  
  glimpse()

prev$prevalence_estimates %>% 
  ggplot(aes(start_time, prev))+
  geom_point()+
  scale_y_continuous(labels = scales::percent,
                     limits = c(0,NA))+
  theme_minimal()

```


To calculate period prevalence by month (i.e. each period is a calendar month)
```{r, message= FALSE, warning=FALSE}
prev <- collect_pop_prevalence(
  db = db,
  results_schema_outcome = NULL,
  table_name_outcomes = "outcome",
  cohort_ids_outcomes = "1",
  cohort_ids_denominator_pops = "1",
  study_denominator_pop = dpop,
  time_intervals="Months",
  type = "period",
  minimum_cell_count = 0
)

prev$prevalence_estimates  %>%  
  glimpse()

prev$prevalence_estimates %>% 
  ggplot(aes(start_time, prev))+
  geom_point()+
  scale_y_continuous(labels = scales::percent,
                     limits = c(0,NA))+
  theme_minimal()

```

### Influence prevalence by modifing mock data
We can influence the prevalence by setting certain parameters of the mock data. These parameters are gender_beta, age_beta and intercept and they are components in the (logistics regression) outcome model. The pre factor is calculated like this:

```{r calc_pre, eval=FALSE}
pre = exp(age_beta * age + gender_beta * male_flag + intercept) / 
      (1 + exp(age_beta * age + gender_beta * male_flag + intercept))
```
where age is the scaled age with mean 0 and male_flag is the binary value for gender (1 = male, 0 = female).
Let's plot the period prevalence by month again and notice between the difference between the previous plot.

```{r, message= FALSE, warning=FALSE}
db2<-generate_mock_incidence_prevalence_db(sample_size=500000,
                                           out_pre=0.5,
                                           age_beta = 5,
                                           gender_beta = 2,
                                           intercept = -1,
                                           earliest_observation_start_date=
                                             as.Date("2007-01-01"),
                                           latest_observation_start_date=
                                             as.Date("2016-01-01")
                                           )

print(nrow(dplyr::tbl(db2, "person") %>% collect()))
print(nrow(dplyr::tbl(db2, "outcome") %>% collect()))

dpop2 <- collect_denominator_pops(db = db2,
                                  cdm_database_schema = NULL,
                                  study_start_date= as.Date("2008-01-01"),
                                  study_end_date= as.Date("2016-01-01"),
                                  study_age_stratas = list(c(0,39),
                                                           c(40,59),
                                                           c(60,150)),
                                  study_sex_stratas = c("Male", "Female"),
                                  study_days_prior_history = 0)

prev2 <- collect_pop_prevalence(
  db = db2,
  results_schema_outcome = NULL,
  table_name_outcomes = "outcome",
  cohort_ids_outcomes = "1",
  cohort_ids_denominator_pops = unique(
    dpop2$denominator_populations$cohort_definition_id),
  study_denominator_pop = dpop2$denominator_population,
  time_intervals="months",
  type = "period",
  minimum_cell_count = 0
)



prev2$prevalence_estimates %>% 
  left_join(prev2$analysis_settings,
            by = "prevalence_analysis_id") %>% 
  left_join(dpop2$denominator_settings,
            by=c("cohort_id_denominator_pop"="cohort_definition_id")) %>% 
  ggplot(aes(start_time, prev))+
  facet_grid(age_strata ~ sex_strata)+
  geom_point()+
  scale_y_continuous(labels = scales::percent,
                     limits = c(0,NA))+
  theme_bw()
```
