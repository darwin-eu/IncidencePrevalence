---
title: "Calculating prevalence"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{a05_Calculating_prevalence}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width=7, 
  fig.height=5
)
```

```{r, message= FALSE, warning=FALSE, echo=FALSE}
library(here)
library(ggplot2)
library(DBI)
library(dbplyr)
library(dplyr)
library(tibble)
library(tidyr)
library(duckdb)
library(knitr)
library(IncidencePrevalence)
```

# Introduction
Prevalence is the total number of people with an ongoing health-related event, such as a medical condition or medication use, at a particular time or during a given period divided by the population at risk. In the previous vignettes we have seen how we can identify a denominator population and define and instantiate an outcome cohort. Prevalence then can be calculated to describe the proportion of people in the denominator population who are in the outcome cohort at a specified time point (point prevalence) or over a given time interval (period prevalence).

In the first plot below, we can We can see at time t+2 that 2 out of 5 people were in an outcome cohort, giving a point prevalence of 40%. In the second figure, period prevalence between t+2 and t+3 was also 40%. However for period prevalence between t and t+1, what do we do with those people who only contributed some time during the period? If we included them we´ll have a period prevalence of 20%, whereas if we require that everyone is observed for the full period to contribute then we´ll have a period prevalence of 33%.  

```{r,echo=FALSE, out.width="80%"}
knitr::include_graphics(here("vignettes/point_prev.png"))
```

```{r,echo=FALSE, out.width="80%"}
knitr::include_graphics(here("vignettes/period_prev.png"))
```

# Using collect_pop_prevalence()
`collect_pop_prevalence()` is the function we use to estimate prevalence. To demonstrate its use, let´s load the IncidencePrevalence package (along with a couple of packages to help for subsequent plots) and generate 50,000 example patients using the `generate_mock_incidence_prevalence_db()` function, from whom we´ll create a denominator population without adding any restrictions other than a study period.

```{r setup}
library(IncidencePrevalence)
library(dplyr)
library(tidyr)
library(ggplot2)

db<-generate_mock_incidence_prevalence_db(sample_size=50000,
                                          out_pre=0.5)

dpop <- collect_denominator_pops(db = db,
                                 cdm_database_schema = NULL,
                                 study_start_date= as.Date("2008-01-01"),
                                 study_end_date= as.Date("2012-01-01"),
                                 study_age_stratas = NULL,
                                 study_sex_stratas = "Both",
                                 study_days_prior_history = 0)
dpop<-dpop$denominator_population 
dpop %>%  
  glimpse()
```

Let´s first calculate point prevalence on a yearly basis.
```{r, message= FALSE, warning=FALSE}
prev <- collect_pop_prevalence(
  db = db,
  results_schema_outcome = NULL,
  table_name_outcomes = "outcome",
  cohort_ids_outcomes = "1",
  cohort_ids_denominator_pops = "1",
  study_denominator_pop = dpop,
  time_intervals="Years",
  periods = "point",
  minimum_cell_count = 0
)

prev$prevalence_estimates  %>%  
  glimpse()

prev$prevalence_estimates %>% 
  ggplot(aes(calendar_year, prev))+
  geom_point()+
  scale_y_continuous(labels = scales::percent,
                     limits = c(0,NA))+
  theme_minimal()

```

We can also calculate point prevalence by calendar month
```{r, message= FALSE, warning=FALSE}
prev <- collect_pop_prevalence(
  db = db,
  results_schema_outcome = NULL,
  table_name_outcomes = "outcome",
  cohort_ids_outcomes = "1",
  cohort_ids_denominator_pops = "1",
  study_denominator_pop = dpop,
  time_intervals="Months",
  periods = "point",
  minimum_cell_count = 0
)

prev$prevalence_estimates  %>%  
  glimpse()

prev$prevalence_estimates %>% 
  mutate(calendar_month=as.Date(paste0(calendar_year,"-", calendar_month, "-01"))) %>% 
  ggplot(aes(calendar_month, prev))+
  geom_point()+
  scale_y_continuous(labels = scales::percent,
                     limits = c(0,NA))+
  theme_minimal()

```

To calculate period prevalence by year (i.e. each period is a calendar year)
```{r, message= FALSE, warning=FALSE}
prev <- collect_pop_prevalence(
  db = db,
  results_schema_outcome = NULL,
  table_name_outcomes = "outcome",
  cohort_ids_outcomes = "1",
  cohort_ids_denominator_pops = "1",
  study_denominator_pop = dpop,
  time_intervals="Years",
  periods = "Year",
  minimum_cell_count = 0
)

prev$prevalence_estimates  %>%  
  glimpse()

prev$prevalence_estimates %>% 
  ggplot(aes(calendar_year, prev))+
  geom_point()+
  scale_y_continuous(labels = scales::percent,
                     limits = c(0,NA))+
  theme_minimal()

```


To calculate period prevalence by month (i.e. each period is a calendar month)
```{r, message= FALSE, warning=FALSE}
prev <- collect_pop_prevalence(
  db = db,
  results_schema_outcome = NULL,
  table_name_outcomes = "outcome",
  cohort_ids_outcomes = "1",
  cohort_ids_denominator_pops = "1",
  study_denominator_pop = dpop,
  time_intervals="Months",
  periods = "Month",
  minimum_cell_count = 0
)

prev$prevalence_estimates  %>%  
  glimpse()

prev$prevalence_estimates %>% 
    mutate(calendar_month=as.Date(paste0(calendar_year,"-", calendar_month, "-01"))) %>% 
  ggplot(aes(calendar_month, prev))+
  geom_point()+
  scale_y_continuous(labels = scales::percent,
                     limits = c(0,NA))+
  theme_minimal()

```
